<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Class: AbstractFile</title>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
  <meta http-equiv="Content-Script-Type" content="text/javascript" />
  <link rel="stylesheet" href=".././rdoc-style.css" type="text/css" media="screen" />
  <script type="text/javascript">
  // <![CDATA[

  function popupCode( url ) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }

  function toggleCode( id ) {
    if ( document.getElementById )
      elem = document.getElementById( id );
    else if ( document.all )
      elem = eval( "document.all." + id );
    else
      return false;

    elemStyle = elem.style;
    
    if ( elemStyle.display != "block" ) {
      elemStyle.display = "block"
    } else {
      elemStyle.display = "none"
    }

    return true;
  }
  
  // Make codeblocks hidden by default
  document.writeln( "<style type=\"text/css\">div.method-source-code { display: none }</style>" )
  
  // ]]>
  </script>

</head>
<body>



    <div id="classHeader">
        <table class="header-table">
        <tr class="top-aligned-row">
          <td><strong>Class</strong></td>
          <td class="class-name-in-header">AbstractFile</td>
        </tr>
        <tr class="top-aligned-row">
            <td><strong>In:</strong></td>
            <td>
                <a href="../files/app/models/abstract_file_rb.html">
                app/models/abstract_file.rb
                </a>
        <br />
            </td>
        </tr>

        <tr class="top-aligned-row">
            <td><strong>Parent:</strong></td>
            <td>
                ActiveRecord::Base
            </td>
        </tr>
        </table>
    </div>
  <!-- banner header -->

  <div id="bodyContent">



  <div id="contextContent">



   </div>

    <div id="method-list">
      <h3 class="section-bar">Methods</h3>

      <div class="name-list">
      <a href="#M000068">before_create</a>&nbsp;&nbsp;
      <a href="#M000039">cached_exist?</a>&nbsp;&nbsp;
      <a href="#M000038">cached_path</a>&nbsp;&nbsp;
      <a href="#M000031">clean_up_from_upload</a>&nbsp;&nbsp;
      <a href="#M000036">clean_up_from_upload</a>&nbsp;&nbsp;
      <a href="#M000037">copy_to_cache</a>&nbsp;&nbsp;
      <a href="#M000060">delete_pending</a>&nbsp;&nbsp;
      <a href="#M000064">destroy_pending_file</a>&nbsp;&nbsp;
      <a href="#M000042">dir_name</a>&nbsp;&nbsp;
      <a href="#M000035">encrypt</a>&nbsp;&nbsp;
      <a href="#M000043">example_root</a>&nbsp;&nbsp;
      <a href="#M000054">exist_on_s3?</a>&nbsp;&nbsp;
      <a href="#M000034">find_pending</a>&nbsp;&nbsp;
      <a href="#M000030">find_temp</a>&nbsp;&nbsp;
      <a href="#M000033">find_uploaded</a>&nbsp;&nbsp;
      <a href="#M000066">fix_mime_type</a>&nbsp;&nbsp;
      <a href="#M000040">full_dir_path</a>&nbsp;&nbsp;
      <a href="#M000041">full_file_path</a>&nbsp;&nbsp;
      <a href="#M000067">get_state</a>&nbsp;&nbsp;
      <a href="#M000055">is_pending?</a>&nbsp;&nbsp;
      <a href="#M000056">local_uri</a>&nbsp;&nbsp;
      <a href="#M000052">old_s3_implementation?</a>&nbsp;&nbsp;
      <a href="#M000046">pending_dir_path</a>&nbsp;&nbsp;
      <a href="#M000051">pending_exist?</a>&nbsp;&nbsp;
      <a href="#M000047">pending_full_dir_path</a>&nbsp;&nbsp;
      <a href="#M000048">pending_full_file_path</a>&nbsp;&nbsp;
      <a href="#M000050">pending_path</a>&nbsp;&nbsp;
      <a href="#M000044">pending_public_root</a>&nbsp;&nbsp;
      <a href="#M000049">pending_root</a>&nbsp;&nbsp;
      <a href="#M000045">pending_temp_root</a>&nbsp;&nbsp;
      <a href="#M000061">pending_uploaded</a>&nbsp;&nbsp;
      <a href="#M000057">public_uri</a>&nbsp;&nbsp;
      <a href="#M000059">read_pending</a>&nbsp;&nbsp;
      <a href="#M000063">remove_local_file</a>&nbsp;&nbsp;
      <a href="#M000058">s3_uri</a>&nbsp;&nbsp;
      <a href="#M000062">save_to_pending_storage</a>&nbsp;&nbsp;
      <a href="#M000053">tmp?</a>&nbsp;&nbsp;
      <a href="#M000028">total_byte_size</a>&nbsp;&nbsp;
      <a href="#M000029">total_size</a>&nbsp;&nbsp;
      <a href="#M000065">upload_to_s3</a>&nbsp;&nbsp;
      <a href="#M000032">write_to_temp_file</a>&nbsp;&nbsp;
      </div>
    </div>

  </div>


    <!-- if includes -->
    <div id="includes">
      <h3 class="section-bar">Included Modules</h3>

      <div id="includes-list">
        <span class="include-name">AWS::S3</span>
      </div>
    </div>

    <div id="section">


    <div id="constants-list">
      <h3 class="section-bar">Constants</h3>

      <div class="name-list">
        <table summary="Constants">
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">STATE_NAMES</td>
          <td>=</td>
          <td class="context-item-value">%w{DISABLED_FINAL DISABLED_PENDING DISABLED_UPLOADED FINAL PENDING UPLOADED TMP}</td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">TMP</td>
          <td>=</td>
          <td class="context-item-value">0, 1, 2, 3, 4, 5, 6</td>
        </tr>
        </table>
      </div>
    </div>



      


    <!-- if method_list -->
    <div id="methods">
      <h3 class="section-bar">Public Class methods</h3>

      <div id="method-M000031" class="method-detail">
        <a name="M000031"></a>

        <div class="method-heading">
          <a href="#M000031" class="method-signature">
          <span class="method-name">clean_up_from_upload</span><span class="method-args">(id)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000031-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000031-source">
<pre>
    <span class="ruby-comment cmt"># File app/models/abstract_file.rb, line 44</span>
44:     <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">clean_up_from_upload</span> <span class="ruby-identifier">id</span>
45:         <span class="ruby-comment cmt"># optimize update maybe or not</span>
46:         <span class="ruby-identifier">doc</span> = <span class="ruby-identifier">find</span>(<span class="ruby-identifier">id</span>)
47:         <span class="ruby-identifier">doc</span>.<span class="ruby-identifier">upload_id</span> = <span class="ruby-keyword kw">nil</span>
48:         <span class="ruby-identifier">doc</span>.<span class="ruby-identifier">session_id</span> = <span class="ruby-keyword kw">nil</span>
49:         <span class="ruby-identifier">doc</span>.<span class="ruby-identifier">save!</span>
50:         <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span>(<span class="ruby-node">&quot;Removed sessions and uploads id for document with ID #{id}&quot;</span>)
51:         <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">doc</span>
52:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000035" class="method-detail">
        <a name="M000035"></a>

        <div class="method-heading">
          <a href="#M000035" class="method-signature">
          <span class="method-name">encrypt</span><span class="method-args">(id)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000035-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000035-source">
<pre>
    <span class="ruby-comment cmt"># File app/models/abstract_file.rb, line 66</span>
66:     <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">encrypt</span>(<span class="ruby-identifier">id</span>)
67:       <span class="ruby-constant">Digest</span><span class="ruby-operator">::</span><span class="ruby-constant">SHA1</span>.<span class="ruby-identifier">hexdigest</span>(<span class="ruby-node">&quot;SCHNAUZER--#{id}--&quot;</span>)
68:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000034" class="method-detail">
        <a name="M000034"></a>

        <div class="method-heading">
          <a href="#M000034" class="method-signature">
          <span class="method-name">find_pending</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000034-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000034-source">
<pre>
    <span class="ruby-comment cmt"># File app/models/abstract_file.rb, line 62</span>
62:     <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">find_pending</span>
63:       <span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;storage_state = ? or storage_state = ?&quot;</span>, <span class="ruby-constant">PENDING</span>, <span class="ruby-constant">DISABLED_PENDING</span>])
64:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000030" class="method-detail">
        <a name="M000030"></a>

        <div class="method-heading">
          <a href="#M000030" class="method-signature">
          <span class="method-name">find_temp</span><span class="method-args">(id=0, upload_id=0, session_id=0)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000030-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000030-source">
<pre>
    <span class="ruby-comment cmt"># File app/models/abstract_file.rb, line 38</span>
38:     <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">find_temp</span> <span class="ruby-identifier">id</span>=<span class="ruby-value">0</span>, <span class="ruby-identifier">upload_id</span>=<span class="ruby-value">0</span>, <span class="ruby-identifier">session_id</span>=<span class="ruby-value">0</span>
39:       <span class="ruby-comment cmt"># this strange thing is actually a security precaution to retrive files </span>
40:       <span class="ruby-comment cmt"># during widget creation before the widget was saved yet</span>
41:       <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">find_by_id_and_upload_id_and_session_id</span>(<span class="ruby-identifier">id</span>, <span class="ruby-identifier">upload_id</span>, <span class="ruby-identifier">session_id</span>)
42:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000033" class="method-detail">
        <a name="M000033"></a>

        <div class="method-heading">
          <a href="#M000033" class="method-signature">
          <span class="method-name">find_uploaded</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000033-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000033-source">
<pre>
    <span class="ruby-comment cmt"># File app/models/abstract_file.rb, line 58</span>
58:     <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">find_uploaded</span>
59:       <span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;storage_state = ? or storage_state = ?&quot;</span>, <span class="ruby-constant">UPLOADED</span>, <span class="ruby-constant">DISABLED_UPLOADED</span>])
60:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000028" class="method-detail">
        <a name="M000028"></a>

        <div class="method-heading">
          <a href="#M000028" class="method-signature">
          <span class="method-name">total_byte_size</span><span class="method-args">(id=0)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000028-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000028-source">
<pre>
    <span class="ruby-comment cmt"># File app/models/abstract_file.rb, line 15</span>
15:     <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">total_byte_size</span> <span class="ruby-identifier">id</span>=<span class="ruby-value">0</span>
16:       <span class="ruby-identifier">find_by_sql</span>(<span class="ruby-node">&quot;select sum(size) from abstract_files where user_id = '#{id.to_i}' and (type = 'ImageFile' or type = 'DocumentFile')&quot;</span>).<span class="ruby-identifier">first</span>[<span class="ruby-value str">&quot;sum(size)&quot;</span>].<span class="ruby-identifier">to_f</span>
17:       <span class="ruby-keyword kw">rescue</span>
18:         <span class="ruby-value">0</span>
19:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000029" class="method-detail">
        <a name="M000029"></a>

        <div class="method-heading">
          <a href="#M000029" class="method-signature">
          <span class="method-name">total_size</span><span class="method-args">(id=0, s=&quot;auto&quot;)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000029-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000029-source">
<pre>
    <span class="ruby-comment cmt"># File app/models/abstract_file.rb, line 21</span>
21:     <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">total_size</span> <span class="ruby-identifier">id</span>=<span class="ruby-value">0</span>, <span class="ruby-identifier">s</span>=<span class="ruby-value str">&quot;auto&quot;</span>
22:       <span class="ruby-identifier">bytes</span> = <span class="ruby-identifier">total_byte_size</span>(<span class="ruby-identifier">id</span>)
23:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;auto&quot;</span>
24:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">bytes</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1073741823</span>
25:           <span class="ruby-identifier">s</span>,<span class="ruby-identifier">a</span> = <span class="ruby-value str">&quot;gigabytes&quot;</span>,<span class="ruby-value str">&quot;GB&quot;</span>
26:         <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">bytes</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1048575</span> 
27:           <span class="ruby-identifier">s</span>,<span class="ruby-identifier">a</span> = <span class="ruby-value str">&quot;megabytes&quot;</span>,<span class="ruby-value str">&quot;MB&quot;</span>
28:         <span class="ruby-keyword kw">else</span>
29:           <span class="ruby-identifier">s</span>,<span class="ruby-identifier">a</span> = <span class="ruby-value str">&quot;kilobytes&quot;</span>,<span class="ruby-value str">&quot;kB&quot;</span>
30:         <span class="ruby-keyword kw">end</span>
31:       <span class="ruby-keyword kw">end</span>
32:       <span class="ruby-identifier">v</span> = <span class="ruby-identifier">bytes</span> <span class="ruby-operator">/</span> <span class="ruby-value">1</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">s</span>.<span class="ruby-identifier">to_s</span>)
33:       <span class="ruby-keyword kw">return</span> <span class="ruby-constant">HashWithIndifferentAccess</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">:value</span> =<span class="ruby-operator">&gt;</span> (<span class="ruby-identifier">s</span>.<span class="ruby-identifier">to_s</span><span class="ruby-operator">==</span><span class="ruby-value str">&quot;kilobytes&quot;</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">v</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">:</span> (<span class="ruby-identifier">v</span><span class="ruby-operator">*</span><span class="ruby-value">100</span>).<span class="ruby-identifier">to_i</span>.<span class="ruby-identifier">to_f</span><span class="ruby-operator">/</span><span class="ruby-value">100</span>),<span class="ruby-identifier">:abr</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">a</span>)
34:       <span class="ruby-keyword kw">rescue</span>
35:         <span class="ruby-value">0</span>
36:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000032" class="method-detail">
        <a name="M000032"></a>

        <div class="method-heading">
          <a href="#M000032" class="method-signature">
          <span class="method-name">write_to_temp_file</span><span class="method-args">(data, path=nil)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000032-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000032-source">
<pre>
    <span class="ruby-comment cmt"># File app/models/abstract_file.rb, line 54</span>
54:     <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">write_to_temp_file</span> <span class="ruby-identifier">data</span>, <span class="ruby-identifier">path</span>=<span class="ruby-keyword kw">nil</span>
55:       <span class="ruby-constant">Technoweenie</span><span class="ruby-operator">::</span><span class="ruby-constant">AttachmentFu</span>.<span class="ruby-identifier">write_to_temp_file</span>(<span class="ruby-identifier">data</span>, <span class="ruby-identifier">path</span>)
56:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <h3 class="section-bar">Public Instance methods</h3>

      <div id="method-M000068" class="method-detail">
        <a name="M000068"></a>

        <div class="method-heading">
          <a href="#M000068" class="method-signature">
          <span class="method-name">before_create</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000068-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000068-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/abstract_file.rb, line 258</span>
258:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">before_create</span>
259:       <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">storage_state</span> = <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">tmp?</span> <span class="ruby-value">? </span><span class="ruby-constant">TMP</span> <span class="ruby-operator">:</span> <span class="ruby-constant">PENDING</span>
260:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000039" class="method-detail">
        <a name="M000039"></a>

        <div class="method-heading">
          <a href="#M000039" class="method-signature">
          <span class="method-name">cached_exist?</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000039-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000039-source">
<pre>
    <span class="ruby-comment cmt"># File app/models/abstract_file.rb, line 85</span>
85:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">cached_exist?</span>
86:        <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span>(<span class="ruby-node">&quot;Cached path: #{cached_path}&quot;</span>)
87:        <span class="ruby-constant">File</span>.<span class="ruby-identifier">exist?</span> <span class="ruby-identifier">cached_path</span>
88:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000038" class="method-detail">
        <a name="M000038"></a>

        <div class="method-heading">
          <a href="#M000038" class="method-signature">
          <span class="method-name">cached_path</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000038-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000038-source">
<pre>
    <span class="ruby-comment cmt"># File app/models/abstract_file.rb, line 81</span>
81:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">cached_path</span>
82:       <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">&quot;&quot;</span>,<span class="ruby-value str">&quot;tmp&quot;</span>,<span class="ruby-value str">&quot;photo_regenerate_store&quot;</span>,<span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">base_path</span>,<span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">filename</span>)
83:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000036" class="method-detail">
        <a name="M000036"></a>

        <div class="method-heading">
          <a href="#M000036" class="method-signature">
          <span class="method-name">clean_up_from_upload</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000036-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000036-source">
<pre>
    <span class="ruby-comment cmt"># File app/models/abstract_file.rb, line 70</span>
70:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">clean_up_from_upload</span>
71:       <span class="ruby-comment cmt"># optimize update maybe or not</span>
72:       <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">update_attributes!</span>(<span class="ruby-identifier">:upload_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">nil</span>, <span class="ruby-identifier">:session_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">nil</span>)
73:       <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span>(<span class="ruby-node">&quot;Removed sessions and uploads id for file with ID #{id}&quot;</span>)
74:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000037" class="method-detail">
        <a name="M000037"></a>

        <div class="method-heading">
          <a href="#M000037" class="method-signature">
          <span class="method-name">copy_to_cache</span><span class="method-args">(path)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000037-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000037-source">
<pre>
    <span class="ruby-comment cmt"># File app/models/abstract_file.rb, line 76</span>
76:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">copy_to_cache</span> <span class="ruby-identifier">path</span>
77:       <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">mkdir_p</span>(<span class="ruby-constant">File</span>.<span class="ruby-identifier">dirname</span>(<span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">cached_path</span>))
78:       <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">cp</span>(<span class="ruby-identifier">path</span>, <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">cached_path</span>)
79:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000060" class="method-detail">
        <a name="M000060"></a>

        <div class="method-heading">
          <a href="#M000060" class="method-signature">
          <span class="method-name">delete_pending</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000060-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000060-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/abstract_file.rb, line 190</span>
190:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">delete_pending</span>
191:       <span class="ruby-identifier">remove_local_file</span>
192:       <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">update_attribute</span>(<span class="ruby-identifier">:storage_state</span>, <span class="ruby-identifier">get_state</span>(<span class="ruby-constant">FINAL</span>))
193:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000064" class="method-detail">
        <a name="M000064"></a>

        <div class="method-heading">
          <a href="#M000064" class="method-signature">
          <span class="method-name">destroy_pending_file</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000064-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000064-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/abstract_file.rb, line 216</span>
216:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">destroy_pending_file</span>
217:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">exist_on_s3?</span>
218:         <span class="ruby-constant">S3Object</span>.<span class="ruby-identifier">delete</span> <span class="ruby-identifier">full_file_path</span>, <span class="ruby-identifier">bucket_name</span>
219:       <span class="ruby-keyword kw">else</span>
220:         <span class="ruby-identifier">remove_local_file</span>
221:       <span class="ruby-keyword kw">end</span>
222:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000042" class="method-detail">
        <a name="M000042"></a>

        <div class="method-heading">
          <a href="#M000042" class="method-signature">
          <span class="method-name">dir_name</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000042-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000042-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/abstract_file.rb, line 98</span>
 98:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">dir_name</span>
 99:       <span class="ruby-identifier">old_s3_implementation?</span> <span class="ruby-value">? </span><span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">attachment_path_id</span> <span class="ruby-operator">:</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">encrypt</span>(<span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">attachment_path_id</span>)
100:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000043" class="method-detail">
        <a name="M000043"></a>

        <div class="method-heading">
          <a href="#M000043" class="method-signature">
          <span class="method-name">example_root</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000043-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000043-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/abstract_file.rb, line 102</span>
102:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">example_root</span>
103:       <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">&quot;images&quot;</span>,<span class="ruby-value str">&quot;example_originals&quot;</span>)
104:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000054" class="method-detail">
        <a name="M000054"></a>

        <div class="method-heading">
          <a href="#M000054" class="method-signature">
          <span class="method-name">exist_on_s3?</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000054-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000054-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/abstract_file.rb, line 148</span>
148:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">exist_on_s3?</span>
149:       (<span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">storage_state</span> <span class="ruby-operator">!=</span> <span class="ruby-constant">PENDING</span>) <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">storage_state</span> <span class="ruby-operator">!=</span> <span class="ruby-constant">DISABLED_PENDING</span>) <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">storage_state</span> <span class="ruby-operator">!=</span> <span class="ruby-constant">TMP</span>)
150:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000066" class="method-detail">
        <a name="M000066"></a>

        <div class="method-heading">
          <a href="#M000066" class="method-signature">
          <span class="method-name">fix_mime_type</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000066-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000066-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/abstract_file.rb, line 240</span>
240:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">fix_mime_type</span>
241:       <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">attachment_options</span>[<span class="ruby-identifier">:content_type</span>]
242:       <span class="ruby-identifier">str</span> = (<span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">content_type</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-operator">!</span>(<span class="ruby-identifier">attachment_options</span>[<span class="ruby-identifier">:content_type</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">content_type</span>))) <span class="ruby-operator">?</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">filename</span>[<span class="ruby-regexp re">/.*\.(.*)/</span>, <span class="ruby-value">1</span>] <span class="ruby-operator">:</span> <span class="ruby-keyword kw">nil</span>
243:       <span class="ruby-comment cmt"># dont bother it type is good, str will be nil if content-type matched allowed ones</span>
244:       <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">str</span>.<span class="ruby-identifier">nil?</span>
245:       <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">content_type</span> = <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">str</span>.<span class="ruby-identifier">downcase</span>
246:         <span class="ruby-keyword kw">when</span> <span class="ruby-regexp re">/jpg|jepg|gepj/</span> <span class="ruby-operator">:</span> <span class="ruby-value str">&quot;image/jpeg&quot;</span>
247:         <span class="ruby-keyword kw">when</span> <span class="ruby-regexp re">/png|gnp/</span> <span class="ruby-operator">:</span> <span class="ruby-value str">&quot;image/png&quot;</span>
248:         <span class="ruby-keyword kw">when</span> <span class="ruby-regexp re">/gif|fig/</span> <span class="ruby-operator">:</span> <span class="ruby-value str">&quot;image/gif&quot;</span>
249:         <span class="ruby-keyword kw">when</span> <span class="ruby-regexp re">/pdf/</span> <span class="ruby-operator">:</span> <span class="ruby-value str">&quot;application/pdf&quot;</span>
250:         <span class="ruby-keyword kw">else</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">content_type</span>
251:       <span class="ruby-keyword kw">end</span>
252:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000040" class="method-detail">
        <a name="M000040"></a>

        <div class="method-heading">
          <a href="#M000040" class="method-signature">
          <span class="method-name">full_dir_path</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000040-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000040-source">
<pre>
    <span class="ruby-comment cmt"># File app/models/abstract_file.rb, line 90</span>
90:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">full_dir_path</span>
91:       <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-identifier">attachment_options</span>[<span class="ruby-identifier">:path_prefix</span>],<span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">dir_name</span>)
92:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000041" class="method-detail">
        <a name="M000041"></a>

        <div class="method-heading">
          <a href="#M000041" class="method-signature">
          <span class="method-name">full_file_path</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000041-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000041-source">
<pre>
    <span class="ruby-comment cmt"># File app/models/abstract_file.rb, line 94</span>
94:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">full_file_path</span>
95:       <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">full_dir_path</span>,<span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">filename</span>)
96:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000067" class="method-detail">
        <a name="M000067"></a>

        <div class="method-heading">
          <a href="#M000067" class="method-signature">
          <span class="method-name">get_state</span><span class="method-args">(state)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000067-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000067-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/abstract_file.rb, line 254</span>
254:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">get_state</span> <span class="ruby-identifier">state</span>
255:       <span class="ruby-identifier">old_s3_implementation?</span> <span class="ruby-value">? </span><span class="ruby-identifier">eval</span>(<span class="ruby-value str">&quot;DISABLED_&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-constant">STATE_NAMES</span>[<span class="ruby-identifier">state</span>]) <span class="ruby-operator">:</span> <span class="ruby-identifier">state</span>
256:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000055" class="method-detail">
        <a name="M000055"></a>

        <div class="method-heading">
          <a href="#M000055" class="method-signature">
          <span class="method-name">is_pending?</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000055-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000055-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/abstract_file.rb, line 152</span>
152:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">is_pending?</span>
153:       <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">storage_state</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">get_state</span>(<span class="ruby-constant">PENDING</span>)
154:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000056" class="method-detail">
        <a name="M000056"></a>

        <div class="method-heading">
          <a href="#M000056" class="method-signature">
          <span class="method-name">local_uri</span><span class="method-args">(args={})</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000056-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000056-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/abstract_file.rb, line 156</span>
156:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">local_uri</span> <span class="ruby-identifier">args</span>={}
157:       <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">attachment_options</span>[<span class="ruby-identifier">:s3_access</span>]<span class="ruby-operator">==</span><span class="ruby-identifier">:authenticated_read</span>
158:         <span class="ruby-identifier">attr_file</span> = <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">class</span><span class="ruby-operator">==</span><span class="ruby-constant">DocumentFile</span> <span class="ruby-value">? </span><span class="ruby-value str">&quot;file&quot;</span> <span class="ruby-operator">:</span> <span class="ruby-value str">&quot;photo&quot;</span> 
159:         <span class="ruby-identifier">widget</span> = <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">class</span><span class="ruby-operator">==</span><span class="ruby-constant">DocumentFile</span> <span class="ruby-value">? </span><span class="ruby-value str">&quot;document&quot;</span> <span class="ruby-operator">:</span> <span class="ruby-value str">&quot;photo&quot;</span> 
160:         <span class="ruby-identifier">args</span>.<span class="ruby-identifier">stringify_keys</span>
161:         <span class="ruby-identifier">args</span>.<span class="ruby-identifier">merge!</span>(<span class="ruby-node">&quot;#{attr_file}_id&quot;</span>=<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">id</span>)
162:         <span class="ruby-identifier">search_str</span> = <span class="ruby-identifier">args</span>.<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">k</span>,<span class="ruby-identifier">v</span><span class="ruby-operator">|</span> <span class="ruby-node">&quot;#{k}=#{v}&quot;</span>}.<span class="ruby-identifier">join</span>(<span class="ruby-value str">&quot;&amp;&quot;</span>)
163:         <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">&quot;widgets&quot;</span>,<span class="ruby-identifier">widget</span>,<span class="ruby-identifier">attr_file</span>,<span class="ruby-node">&quot;#{self.filename}?#{search_str}&quot;</span>)
164:       <span class="ruby-keyword kw">else</span>
165:         <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">&quot;&quot;</span>,<span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">pending_public_root</span>,<span class="ruby-identifier">pending_full_file_path</span>)
166:       <span class="ruby-keyword kw">end</span>
167:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000052" class="method-detail">
        <a name="M000052"></a>

        <div class="method-heading">
          <a href="#M000052" class="method-signature">
          <span class="method-name">old_s3_implementation?</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000052-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000052-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/abstract_file.rb, line 139</span>
139:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">old_s3_implementation?</span>
140:       <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">true</span> <span class="ruby-comment cmt"># Do not encrypt path during live testing to keep the same url format as the current version</span>
141:       <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">storage_state</span> <span class="ruby-operator">==</span> <span class="ruby-constant">DISABLED_PENDING</span> <span class="ruby-operator">||</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">storage_state</span> <span class="ruby-operator">==</span> <span class="ruby-constant">DISABLED_UPLOADED</span> <span class="ruby-operator">||</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">storage_state</span> <span class="ruby-operator">==</span> <span class="ruby-constant">DISABLED_FINAL</span>
142:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000046" class="method-detail">
        <a name="M000046"></a>

        <div class="method-heading">
          <a href="#M000046" class="method-signature">
          <span class="method-name">pending_dir_path</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000046-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000046-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/abstract_file.rb, line 115</span>
115:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">pending_dir_path</span>
116:       <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-identifier">pending_root</span>,<span class="ruby-identifier">pending_full_dir_path</span>)
117:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000051" class="method-detail">
        <a name="M000051"></a>

        <div class="method-heading">
          <a href="#M000051" class="method-signature">
          <span class="method-name">pending_exist?</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000051-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000051-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/abstract_file.rb, line 135</span>
135:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">pending_exist?</span>
136:       <span class="ruby-constant">File</span>.<span class="ruby-identifier">exist?</span> <span class="ruby-identifier">pending_path</span>
137:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000047" class="method-detail">
        <a name="M000047"></a>

        <div class="method-heading">
          <a href="#M000047" class="method-signature">
          <span class="method-name">pending_full_dir_path</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000047-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000047-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/abstract_file.rb, line 119</span>
119:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">pending_full_dir_path</span>
120:       <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-identifier">attachment_options</span>[<span class="ruby-identifier">:path_prefix</span>],<span class="ruby-identifier">dir_name</span>)
121:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000048" class="method-detail">
        <a name="M000048"></a>

        <div class="method-heading">
          <a href="#M000048" class="method-signature">
          <span class="method-name">pending_full_file_path</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000048-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000048-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/abstract_file.rb, line 123</span>
123:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">pending_full_file_path</span>
124:       <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-identifier">pending_full_dir_path</span>,<span class="ruby-identifier">filename</span>)
125:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000050" class="method-detail">
        <a name="M000050"></a>

        <div class="method-heading">
          <a href="#M000050" class="method-signature">
          <span class="method-name">pending_path</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000050-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000050-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/abstract_file.rb, line 131</span>
131:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">pending_path</span>
132:       <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-identifier">pending_root</span>,<span class="ruby-identifier">pending_full_file_path</span>)
133:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000044" class="method-detail">
        <a name="M000044"></a>

        <div class="method-heading">
          <a href="#M000044" class="method-signature">
          <span class="method-name">pending_public_root</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000044-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000044-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/abstract_file.rb, line 106</span>
106:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">pending_public_root</span>
107:       <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">pending_temp_root</span> <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">tmp?</span>
108:       <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">&quot;images&quot;</span>,<span class="ruby-value str">&quot;pending_storage&quot;</span>,<span class="ruby-value str">&quot;pending_uploads&quot;</span>)
109:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000049" class="method-detail">
        <a name="M000049"></a>

        <div class="method-heading">
          <a href="#M000049" class="method-signature">
          <span class="method-name">pending_root</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000049-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000049-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/abstract_file.rb, line 127</span>
127:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">pending_root</span>
128:       <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-constant">RAILS_ROOT</span>,<span class="ruby-value str">&quot;public&quot;</span>,<span class="ruby-identifier">pending_public_root</span>)
129:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000045" class="method-detail">
        <a name="M000045"></a>

        <div class="method-heading">
          <a href="#M000045" class="method-signature">
          <span class="method-name">pending_temp_root</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000045-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000045-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/abstract_file.rb, line 111</span>
111:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">pending_temp_root</span>
112:       <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">&quot;images&quot;</span>,<span class="ruby-value str">&quot;pending_storage&quot;</span>,<span class="ruby-value str">&quot;pending_temp_uploads&quot;</span>, <span class="ruby-identifier">user_base</span>)
113:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000061" class="method-detail">
        <a name="M000061"></a>

        <div class="method-heading">
          <a href="#M000061" class="method-signature">
          <span class="method-name">pending_uploaded</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000061-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000061-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/abstract_file.rb, line 195</span>
195:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">pending_uploaded</span>
196:       <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">update_attribute</span>(<span class="ruby-identifier">:storage_state</span>, <span class="ruby-identifier">get_state</span>(<span class="ruby-constant">UPLOADED</span>))
197:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000057" class="method-detail">
        <a name="M000057"></a>

        <div class="method-heading">
          <a href="#M000057" class="method-signature">
          <span class="method-name">public_uri</span><span class="method-args">(args={})</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000057-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000057-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/abstract_file.rb, line 169</span>
169:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">public_uri</span> <span class="ruby-identifier">args</span>={}
170:       <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">exist_on_s3?</span>
171:         <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">s3_uri</span>
172:       <span class="ruby-keyword kw">else</span>
173:         <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">local_uri</span>(<span class="ruby-identifier">args</span>)
174:       <span class="ruby-keyword kw">end</span>
175:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000059" class="method-detail">
        <a name="M000059"></a>

        <div class="method-heading">
          <a href="#M000059" class="method-signature">
          <span class="method-name">read_pending</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000059-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000059-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/abstract_file.rb, line 186</span>
186:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">read_pending</span>
187:       <span class="ruby-constant">IO</span>.<span class="ruby-identifier">read</span>(<span class="ruby-identifier">pending_path</span>)
188:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000063" class="method-detail">
        <a name="M000063"></a>

        <div class="method-heading">
          <a href="#M000063" class="method-signature">
          <span class="method-name">remove_local_file</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000063-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000063-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/abstract_file.rb, line 209</span>
209:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">remove_local_file</span>
210:       <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">rm_f</span> <span class="ruby-identifier">pending_path</span>
211:       <span class="ruby-keyword kw">if</span> <span class="ruby-constant">Dir</span>.<span class="ruby-identifier">glob</span>(<span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-identifier">pending_dir_path</span>,<span class="ruby-value str">&quot;*&quot;</span>)).<span class="ruby-identifier">empty?</span>
212:         <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">rmdir</span> <span class="ruby-identifier">pending_dir_path</span>
213:       <span class="ruby-keyword kw">end</span>
214:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000058" class="method-detail">
        <a name="M000058"></a>

        <div class="method-heading">
          <a href="#M000058" class="method-signature">
          <span class="method-name">s3_uri</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000058-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000058-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/abstract_file.rb, line 177</span>
177:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">s3_uri</span>
178:       <span class="ruby-comment cmt"># Remove (self.class==ThumbnailFile &amp;&amp; self.old_s3_implementation?) test after live testing</span>
179:       <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">attachment_options</span>[<span class="ruby-identifier">:s3_access</span>]<span class="ruby-operator">==</span><span class="ruby-identifier">:authenticated_read</span> <span class="ruby-operator">||</span> (<span class="ruby-identifier">old_s3_implementation?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">class</span><span class="ruby-operator">==</span><span class="ruby-constant">AvatarFile</span>) <span class="ruby-operator">||</span> (<span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">class</span><span class="ruby-operator">==</span><span class="ruby-constant">ThumbnailFile</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">old_s3_implementation?</span>)
180:         <span class="ruby-constant">S3Object</span>.<span class="ruby-identifier">url_for</span>(<span class="ruby-identifier">full_file_path</span>, <span class="ruby-identifier">bucket_name</span>,{<span class="ruby-identifier">:expires_in</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">3</span>.<span class="ruby-identifier">minute</span>})
181:       <span class="ruby-keyword kw">else</span>
182:         <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-identifier">s3_protocol</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">s3_hostname</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">s3_port_string</span>, <span class="ruby-identifier">bucket_name</span>, <span class="ruby-identifier">full_file_path</span>)
183:       <span class="ruby-keyword kw">end</span>
184:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000062" class="method-detail">
        <a name="M000062"></a>

        <div class="method-heading">
          <a href="#M000062" class="method-signature">
          <span class="method-name">save_to_pending_storage</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000062-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000062-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/abstract_file.rb, line 199</span>
199:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">save_to_pending_storage</span>
200:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">save_attachment?</span> 
201:         <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">mkdir_p</span>(<span class="ruby-constant">File</span>.<span class="ruby-identifier">dirname</span>(<span class="ruby-identifier">pending_path</span>))
202:         <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">cp</span>(<span class="ruby-identifier">temp_path</span>, <span class="ruby-identifier">pending_path</span>)
203:         <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">chmod</span>(<span class="ruby-value">0644</span>, <span class="ruby-identifier">pending_path</span>)
204:       <span class="ruby-keyword kw">end</span>
205:       <span class="ruby-ivar">@old_filename</span> = <span class="ruby-keyword kw">nil</span>
206:       <span class="ruby-keyword kw">true</span>
207:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000053" class="method-detail">
        <a name="M000053"></a>

        <div class="method-heading">
          <a href="#M000053" class="method-signature">
          <span class="method-name">tmp?</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000053-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000053-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/abstract_file.rb, line 144</span>
144:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">tmp?</span>
145:       <span class="ruby-identifier">user_authorized</span><span class="ruby-operator">==</span><span class="ruby-keyword kw">false</span> <span class="ruby-operator">||</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">storage_state</span> <span class="ruby-operator">==</span> <span class="ruby-constant">TMP</span>
146:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000065" class="method-detail">
        <a name="M000065"></a>

        <div class="method-heading">
          <a href="#M000065" class="method-signature">
          <span class="method-name">upload_to_s3</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000065-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000065-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/abstract_file.rb, line 224</span>
224:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">upload_to_s3</span>
225:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">pending_exist?</span>
226:         <span class="ruby-identifier">options</span> = { <span class="ruby-identifier">:content_type</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">content_type</span>, <span class="ruby-identifier">:access</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">attachment_options</span>[<span class="ruby-identifier">:s3_access</span>]}
227:         <span class="ruby-identifier">options</span>.<span class="ruby-identifier">merge!</span>(<span class="ruby-identifier">:content_disposition</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot;Content-Disposition: attachment; filename=#{filename}&quot;</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">attachment_options</span>[<span class="ruby-identifier">:disposition</span>] <span class="ruby-operator">==</span> <span class="ruby-identifier">:download</span>
228:         <span class="ruby-comment cmt"># Remove the two lines below after live testing</span>
229:         <span class="ruby-identifier">tmp_s3_access</span> = <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">attachment_options</span>[<span class="ruby-identifier">:s3_access</span>]
230:         <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">attachment_options</span>[<span class="ruby-identifier">:s3_access</span>] = <span class="ruby-identifier">:authenticated_read</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">class</span><span class="ruby-operator">==</span><span class="ruby-constant">ThumbnailFile</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">old_s3_implementation?</span>)
231:         <span class="ruby-constant">S3Object</span>.<span class="ruby-identifier">store</span>(<span class="ruby-identifier">full_file_path</span>, <span class="ruby-identifier">read_pending</span>, <span class="ruby-identifier">bucket_name</span>, <span class="ruby-identifier">options</span>)
232:         <span class="ruby-identifier">pending_uploaded</span>
233:         <span class="ruby-comment cmt"># Remove line below after live testing</span>
234:         <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">attachment_options</span>[<span class="ruby-identifier">:s3_access</span>] = <span class="ruby-identifier">tmp_s3_access</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">class</span><span class="ruby-operator">==</span><span class="ruby-constant">ThumbnailFile</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">old_s3_implementation?</span>)
235:         <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">true</span>
236:       <span class="ruby-keyword kw">end</span>
237:       <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">false</span>
238:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>


    </div>


  </div>


<div id="validator-badges">
  <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
</div>

</body>
</html>